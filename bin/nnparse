#!/usr/bin/env ruby
require 'rubygems'
gem 'dimus-biodiversity' rescue gem 'biodiversity' rescue nil

$LOAD_PATH.unshift(File.expand_path(File.dirname(__FILE__) + "/../lib"))
require 'biodiversity'
require 'json'

if ARGV.empty?
  puts "Usage:\n\nnnparse file_with_scientific_names [output_file]\n\ndefault output_file is parsed.json\n\n"
  exit
end

input = ARGV[0]
output = ARGV[1] || 'parsed.json'

p = ScientificNameParser.new
o = open(output, 'w')

count = 0
IO.foreach(input) do |line|
  count += 1
  puts("%s lines parsed" % count) if count % 10000 == 0
  name = line.gsub(/^[\d]*\s*/, '').strip 
  p.parse(name)
  parsed_data = p.parsed.all_json rescue {'parsed' => false, 'verbatim' => name,  'error' => 'Parser error'}.to_json
  o.write parsed_data + "\n"
end

